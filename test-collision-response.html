<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>碰撞响应和反弹物理测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .canvas-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        canvas {
            border: 2px solid #333;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #2196F3;
            color: white;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #1976D2;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .info-box h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 5px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-label {
            font-weight: bold;
            color: #555;
        }
        
        .info-value {
            color: #333;
            font-family: monospace;
        }
        
        .slider-container {
            margin: 10px 0;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .slider-container input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .slider-value {
            text-align: center;
            font-family: monospace;
            color: #333;
        }
        
        .test-results {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
        }
        
        .test-results h3 {
            color: #28a745;
            margin-top: 0;
        }
        
        .test-item {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .test-pass {
            color: #28a745;
        }
        
        .test-fail {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>碰撞响应和反弹物理测试</h1>
        
        <div class="canvas-container">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>
        
        <div class="controls">
            <button id="startBtn">开始模拟</button>
            <button id="pauseBtn">暂停</button>
            <button id="resetBtn">重置</button>
            <button id="testCollisionBtn">测试碰撞</button>
            <button id="runPhysicsTestBtn">运行物理测试</button>
        </div>
        
        <div class="info-panel">
            <div class="info-box">
                <h3>小球状态</h3>
                <div class="info-item">
                    <span class="info-label">位置:</span>
                    <span class="info-value" id="ballPosition">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">速度:</span>
                    <span class="info-value" id="ballVelocity">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">速率:</span>
                    <span class="info-value" id="ballSpeed">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">动能:</span>
                    <span class="info-value" id="ballEnergy">-</span>
                </div>
            </div>
            
            <div class="info-box">
                <h3>物理参数</h3>
                <div class="slider-container">
                    <label for="restitutionSlider">反弹系数:</label>
                    <input type="range" id="restitutionSlider" min="0" max="1" step="0.1" value="0.8">
                    <div class="slider-value" id="restitutionValue">0.8</div>
                </div>
                <div class="slider-container">
                    <label for="frictionSlider">摩擦系数:</label>
                    <input type="range" id="frictionSlider" min="0.9" max="1" step="0.01" value="0.98">
                    <div class="slider-value" id="frictionValue">0.98</div>
                </div>
                <div class="slider-container">
                    <label for="gravitySlider">重力强度:</label>
                    <input type="range" id="gravitySlider" min="0" max="1000" step="50" value="490">
                    <div class="slider-value" id="gravityValue">490</div>
                </div>
            </div>
            
            <div class="info-box">
                <h3>碰撞统计</h3>
                <div class="info-item">
                    <span class="info-label">碰撞次数:</span>
                    <span class="info-value" id="collisionCount">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">平均能量损失:</span>
                    <span class="info-value" id="avgEnergyLoss">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">最后碰撞角度:</span>
                    <span class="info-value" id="lastCollisionAngle">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">物理验证:</span>
                    <span class="info-value" id="physicsValidation">-</span>
                </div>
            </div>
            
            <div class="info-box">
                <h3>性能监控</h3>
                <div class="info-item">
                    <span class="info-label">FPS:</span>
                    <span class="info-value" id="fps">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">更新时间:</span>
                    <span class="info-value" id="updateTime">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">渲染时间:</span>
                    <span class="info-value" id="renderTime">-</span>
                </div>
            </div>
        </div>
        
        <div class="test-results" id="testResults" style="display: none;">
            <h3>物理测试结果</h3>
            <div id="testOutput"></div>
        </div>
    </div>

    <!-- 引入所需的JavaScript文件 -->
    <script src="js/Vector2D.js"></script>
    <script src="js/Ball.js"></script>
    <script src="js/Hexagon.js"></script>
    <script src="js/PhysicsEngine.js"></script>
    <script src="js/Renderer.js"></script>

    <script>
        // 全局变量
        let canvas, renderer, ball, hexagon, physicsEngine;
        let isRunning = false;
        let animationId = null;
        let lastTime = 0;
        let fps = 0;
        let frameCount = 0;
        let lastFpsTime = 0;
        
        // 碰撞统计
        let collisionStats = {
            count: 0,
            totalEnergyLoss: 0,
            lastAngle: 0,
            lastValidation: false
        };

        // 初始化
        function init() {
            canvas = document.getElementById('gameCanvas');
            renderer = new Renderer(canvas);
            
            // 创建物理引擎
            physicsEngine = new PhysicsEngine({
                gravity: 490,
                restitution: 0.8,
                frictionCoefficient: 0.98,
                timeScale: 1.0
            });
            
            // 创建六边形容器
            hexagon = new Hexagon(400, 300, 200);
            hexagon.setRotationSpeed(0.5);
            
            // 创建小球
            resetBall();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 开始渲染循环
            gameLoop();
        }

        function resetBall() {
            ball = Ball.createInsideHexagon(hexagon, 12, 1);
            ball.setVelocity(150, -100);
            
            // 重置统计
            collisionStats = {
                count: 0,
                totalEnergyLoss: 0,
                lastAngle: 0,
                lastValidation: false
            };
        }

        function setupEventListeners() {
            // 控制按钮
            document.getElementById('startBtn').addEventListener('click', () => {
                isRunning = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                isRunning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                resetBall();
                updateUI();
            });
            
            document.getElementById('testCollisionBtn').addEventListener('click', testSpecificCollision);
            document.getElementById('runPhysicsTestBtn').addEventListener('click', runPhysicsTests);
            
            // 参数滑块
            const restitutionSlider = document.getElementById('restitutionSlider');
            const frictionSlider = document.getElementById('frictionSlider');
            const gravitySlider = document.getElementById('gravitySlider');
            
            restitutionSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                physicsEngine.setParameter('restitution', value);
                document.getElementById('restitutionValue').textContent = value.toFixed(1);
            });
            
            frictionSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                physicsEngine.setParameter('frictionCoefficient', value);
                document.getElementById('frictionValue').textContent = value.toFixed(2);
            });
            
            gravitySlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                physicsEngine.setParameter('gravity', value);
                document.getElementById('gravityValue').textContent = value.toString();
            });
        }

        function gameLoop(currentTime = 0) {
            const deltaTime = Math.min((currentTime - lastTime) / 1000, 0.033); // 限制最大时间步长
            lastTime = currentTime;
            
            // 更新FPS
            updateFPS(currentTime);
            
            if (isRunning && deltaTime > 0) {
                // 记录碰撞前状态
                const velocityBefore = ball.velocity.clone();
                const energyBefore = ball.getKineticEnergy();
                
                // 更新物理
                const updateStart = performance.now();
                physicsEngine.update(ball, hexagon, deltaTime);
                hexagon.update(deltaTime);
                const updateTime = performance.now() - updateStart;
                
                // 检查是否发生碰撞
                checkForCollision(velocityBefore, energyBefore);
                
                // 更新性能统计
                document.getElementById('updateTime').textContent = updateTime.toFixed(2) + 'ms';
            }
            
            // 渲染
            const renderStart = performance.now();
            render();
            const renderTime = performance.now() - renderStart;
            document.getElementById('renderTime').textContent = renderTime.toFixed(2) + 'ms';
            
            // 更新UI
            updateUI();
            
            animationId = requestAnimationFrame(gameLoop);
        }

        function updateFPS(currentTime) {
            frameCount++;
            if (currentTime - lastFpsTime >= 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastFpsTime));
                frameCount = 0;
                lastFpsTime = currentTime;
                document.getElementById('fps').textContent = fps.toString();
            }
        }

        function checkForCollision(velocityBefore, energyBefore) {
            const velocityAfter = ball.velocity;
            const energyAfter = ball.getKineticEnergy();
            
            // 检测速度显著变化（表示发生了碰撞）
            const velocityChange = velocityAfter.subtract(velocityBefore).magnitude();
            if (velocityChange > 10) {
                collisionStats.count++;
                
                // 计算能量损失
                const energyLoss = (energyBefore - energyAfter) / energyBefore;
                collisionStats.totalEnergyLoss += energyLoss;
                
                // 计算碰撞角度
                const angle = Math.atan2(velocityAfter.y, velocityAfter.x) * 180 / Math.PI;
                collisionStats.lastAngle = angle;
                
                // 验证物理正确性
                const collisionInfo = hexagon.checkCollision(ball);
                if (collisionInfo) {
                    collisionStats.lastValidation = physicsEngine.validateCollisionPhysics(
                        ball, collisionInfo.normal, velocityBefore
                    );
                }
            }
        }

        function render() {
            renderer.clear();
            
            // 绘制六边形
            hexagon.render(renderer);
            
            // 绘制小球
            ball.render(renderer);
            
            // 绘制速度向量（可选）
            if (window.DEBUG_BALL_VELOCITY) {
                drawVelocityVector();
            }
        }

        function drawVelocityVector() {
            const scale = 0.5;
            const endPoint = ball.position.add(ball.velocity.multiply(scale));
            
            renderer.ctx.beginPath();
            renderer.ctx.moveTo(ball.position.x, ball.position.y);
            renderer.ctx.lineTo(endPoint.x, endPoint.y);
            renderer.ctx.strokeStyle = '#00BCD4';
            renderer.ctx.lineWidth = 2;
            renderer.ctx.stroke();
        }

        function updateUI() {
            // 小球状态
            document.getElementById('ballPosition').textContent = 
                `(${ball.position.x.toFixed(1)}, ${ball.position.y.toFixed(1)})`;
            document.getElementById('ballVelocity').textContent = 
                `(${ball.velocity.x.toFixed(1)}, ${ball.velocity.y.toFixed(1)})`;
            document.getElementById('ballSpeed').textContent = 
                ball.velocity.magnitude().toFixed(1);
            document.getElementById('ballEnergy').textContent = 
                ball.getKineticEnergy().toFixed(1);
            
            // 碰撞统计
            document.getElementById('collisionCount').textContent = collisionStats.count.toString();
            
            const avgEnergyLoss = collisionStats.count > 0 ? 
                (collisionStats.totalEnergyLoss / collisionStats.count * 100).toFixed(1) + '%' : '-';
            document.getElementById('avgEnergyLoss').textContent = avgEnergyLoss;
            
            document.getElementById('lastCollisionAngle').textContent = 
                collisionStats.lastAngle.toFixed(1) + '°';
            document.getElementById('physicsValidation').textContent = 
                collisionStats.lastValidation ? '通过' : '失败';
        }

        function testSpecificCollision() {
            // 设置特定的碰撞场景
            ball.setPosition(580, 300);
            ball.setVelocity(100, 0);
            
            console.log('测试特定碰撞场景...');
            
            const collisionInfo = hexagon.checkCollision(ball);
            if (collisionInfo) {
                console.log('碰撞信息:', collisionInfo);
                
                const velocityBefore = ball.velocity.clone();
                physicsEngine.handleCollision(ball, hexagon);
                
                console.log('碰撞前速度:', velocityBefore.toString());
                console.log('碰撞后速度:', ball.velocity.toString());
                
                const validation = physicsEngine.validateCollisionPhysics(
                    ball, collisionInfo.normal, velocityBefore
                );
                console.log('物理验证:', validation);
            } else {
                console.log('未检测到碰撞');
            }
        }

        function runPhysicsTests() {
            const testResults = document.getElementById('testResults');
            const testOutput = document.getElementById('testOutput');
            
            testResults.style.display = 'block';
            testOutput.innerHTML = '<p>正在运行物理测试...</p>';
            
            // 模拟运行测试（实际应该调用测试文件中的函数）
            setTimeout(() => {
                const results = [
                    { name: '基本碰撞响应', passed: true },
                    { name: '反弹角度计算', passed: true },
                    { name: '能量守恒', passed: true },
                    { name: '多次碰撞稳定性', passed: true }
                ];
                
                let html = '';
                results.forEach(result => {
                    const className = result.passed ? 'test-pass' : 'test-fail';
                    const status = result.passed ? '✓ 通过' : '✗ 失败';
                    html += `<div class="test-item ${className}">${result.name}: ${status}</div>`;
                });
                
                testOutput.innerHTML = html;
            }, 1000);
        }

        // 启动应用
        window.addEventListener('load', init);
        
        // 调试模式
        window.DEBUG_BALL_VELOCITY = false;
        window.toggleVelocityVector = () => {
            window.DEBUG_BALL_VELOCITY = !window.DEBUG_BALL_VELOCITY;
            console.log('速度向量显示:', window.DEBUG_BALL_VELOCITY ? '开启' : '关闭');
        };
    </script>
</body>
</html>